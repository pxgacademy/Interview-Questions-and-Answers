# 6. Middleware basics

Next.js-এ **মিডলওয়্যার** একটি শক্তিশালী ফিচার, যা HTTP রিকোয়েস্ট এবং রেসপন্স প্রসেসিংয়ের মাঝখানে কাস্টম লজিক প্রয়োগ করতে ব্যবহৃত হয়। এটি Next.js অ্যাপ্লিকেশনের রিকোয়েস্ট পাইপলাইনে একটি মধ্যবর্তী স্তর হিসেবে কাজ করে, যেখানে আপনি রিকো� Facade with route handler or page renderingকোয়েস্ট পরিবর্তন, রিডাইরেক্ট, হেডার যোগ করা, অথেনটিকেশন চেক ইত্যাদি করতে পারেন। মিডলওয়্যার App Router এবং Pages Router উভয় ক্ষেত্রেই ব্যবহার করা যায়, তবে এটি বিশেষ করে **App Router**-এ আরও নমনীয় এবং এজ রানটাইমের সাথে সামঞ্জস্যপূর্ণ। সিনিয়র ডেভেলপারদের জন্য মিডলওয়্যারের সঠিক ব্যবহার অ্যাপ্লিকেশনের সিকিউরিটি, পারফরম্যান্স এবং ইউজার এক্সপেরিয়েন্স উন্নত করতে অত্যন্ত গুরুত্বপূর্ণ। এই বিস্তারিত আলোচনায় আমরা মিডলওয়্যারের কাজ, ব্যবহার, এবং সিনিয়র ডেভেলপারদের জন্য গুরুত্বপূর্ণ টিপস নিয়ে আলোচনা করব।

---

## মিডলওয়্যার কী?

**মিডলওয়্যার** হল একটি ফাংশন, যা Next.js অ্যাপ্লিকেশনে আগত HTTP রিকোয়েস্ট প্রসেস করার আগে বা পরে কাস্টম লজিক প্রয়োগ করে। এটি রিকোয়েস্ট এবং রেসপন্সের মধ্যে একটি ফিল্টার হিসেবে কাজ করে, যেখানে আপনি রিকোয়েস্ট পরিবর্তন, রিডাইরেক্ট, বা রেসপন্স কাস্টমাইজ করতে পারেন। মিডলওয়্যার সাধারণত অথেনটিকেশন, লগিং, CORS হ্যান্ডলিং, বা রিকোয়েস্ট হেডার পরিবর্তনের জন্য ব্যবহৃত হয়।

Next.js-এ মিডলওয়্যার `middleware.js` বা `middleware.ts` ফাইলে ডিফাইন করা হয়, যা প্রোজেক্টের রুট ডিরেক্টরি বা `app` ডিরেক্টরিতে থাকে। এটি App Router এবং Pages Router উভয় ক্ষেত্রেই কাজ করে, তবে App Router-এ এটি এজ রানটাইমের সাথে আরও শক্তিশালী।

---

## মিডলওয়্যার কিভাবে কাজ করে?

মিডলওয়্যার ফাংশনটি `NextRequest` এবং `NextResponse` অবজেক্টের সাথে কাজ করে। এটি রিকোয়েস্ট প্রসেস করার আগে ট্রিগার হয় এবং আপনি এর মাধ্যমে রিকোয়েস্ট পরীক্ষা, পরিবর্তন, বা রিডাইরেক্ট করতে পারেন। মিডলওয়্যার সাধারণত নিম্নলিখিত কাজগুলো করে:

- **রিকোয়েস্ট পরীক্ষা**: যেমন, ইউজার অথেনটিকেটেড কিনা চেক করা।
- **রিডাইরেকশন**: নির্দিষ্ট শর্তে ইউজারকে অন্য URL-এ রিডাইরেক্ট করা।
- **হেডার পরিবর্তন**: রিকোয়েস্ট বা রেসপন্সে কাস্টম হেডার যোগ করা।
- **লগিং**: রিকোয়েস্ট ডেটা লগ করা।
- **CORS হ্যান্ডলিং**: ক্রস-অরিজিন রিসোর্স শেয়ারিং সেটআপ।

### উদাহরণ:

```jsx
// middleware.js
import { NextResponse } from "next/server";

export function middleware(request) {
  // ইউজারের টোকেন চেক করা
  const token = request.cookies.get("token")?.value;
  if (!token && request.nextUrl.pathname.startsWith("/dashboard")) {
    return NextResponse.redirect(new URL("/login", request.url));
  }

  // কাস্টম হেডার যোগ করা
  const response = NextResponse.next();
  response.headers.set("x-custom-header", "my-custom-value");
  return response;
}

export const config = {
  matcher: ["/dashboard/:path*"], // শুধুমাত্র /dashboard রাউটে মিডলওয়্যার প্রয়োগ
};
```

এই কোডটি:
- `/dashboard` রাউটে অ্যাক্সেসের আগে ইউজারের টোকেন চেক করে।
- টোকেন না থাকলে `/login` পেজে রিডাইরেক্ট করে।
- প্রতিটি রেসপন্সে একটি কাস্টম হেডার যোগ করে।

---

## মিডলওয়্যারের বৈশিষ্ট্য

1. **ফ্লেক্সিবল ম্যাচিং**:
   - `config.matcher` ব্যবহার করে নির্দিষ্ট রাউটে মিডলওয়্যার প্রয়োগ করা যায়।
   - উদাহরণ: `matcher: ["/dashboard/:path*", "/api/:path*"]` শুধুমাত্র নির্দিষ্ট রাউটে কাজ করে।

2. **এজ রানটাইম সমর্থন**:
   - App Router-এ মিডলওয়্যার এজ রানটাইমে কাজ করতে পারে, যা কম লেটেন্সি প্রদান করে।
   - উদাহরণ: `export const runtime = "edge";`

3. **রিকোয়েস্ট এবং রেসপন্স মডিফিকেশন**:
   - `NextRequest` অবজেক্ট থেকে কুকি, হেডার, বা কুয়েরি প্যারামিটার অ্যাক্সেস করা যায়।
   - `NextResponse` ব্যবহার করে রিডাইরেক্ট, রিরাইট, বা হেডার সেট করা যায়।

4. **অথেনটিকেশন এবং অথরাইজেশন**:
   - JWT, OAuth, বা সেশন-ভিত্তিক অথেনটিকেশন চেক করা।
   - রোল-বেসড অ্যাক্সেস কন্ট্রোল (RBAC) প্রয়োগ।

5. **ইন্টারন্যাশনালাইজেশন (i18n)**:
   - ইউজারের লোকেল বা ভাষা চেক করে রিডাইরেক্ট করা।
   - উদাহরণ: `request.headers.get("accept-language")`

---

## ব্যবহারের ক্ষেত্র

1. **অথেনটিকেশন চেক**:
   - সুরক্ষিত রাউটে অ্যাক্সেসের আগে ইউজার লগইন করেছে কিনা যাচাই করা।
   - উদাহরণ: ড্যাশবোর্ডে অ্যাক্সেসের জন্য টোকেনbeginners guide to Next.js middlewareকেন যাচাই।

2. **রিডাইরেকশন**:
   - শর্তের উপর ভিত্তি করে ইউজারকে অন্য পেজে রিডাইরেক্ট করা।
   - উদাহরণ: অথেনটিকেটেড ইউজারদের জন্য `/dashboard` এবং অন্যদের জন্য `/login`।

3. **CORS হ্যান্ডলিং**:
   - API রাউটে ক্রস-অরিজিন রিকোয়েস্ট অনুমতি দেওয়া।
   - উদাহরণ: `Access-Control-Allow-Origin` হেডার সেট করা।

4. **লগিং এবং মনিটরিং**:
   - রিকোয়েস্ট ডেটা লগ করা বা মেট্রিক্স সংগ্রহ করা।
   - উদাহরণ: প্রতিটি রিকোয়েস্টের IP এবং পেজ ভিউ লগ করা।

5. **A/B টেস্টিং**:
   - ইউজার গ্রুপের উপর ভিত্তি করে ভিন্ন UI বা ফিচার দেখানো।
   - উদাহরণ: কিছু ইউজারের জন্য নতুন ডিজাইন দেখানো।

---

## সিনিয়র ডেভেলপারদের জন্য গুরুত্বপূর্ণ টিপস

1. **পারফরম্যান্স অপটিমাইজেশন**:
   - মিডলওয়্যারে হালকা লজিক রাখুন, কারnullnullবারে এটি প্রতিটি রিকোয়েস্টে রান করে।
   - ডাটাবেস কুয়েরি বা ভারী কম্পিউটেশন এড়িয়ে চলুন।
   - এজ রানটাইম ব্যবহার করে লেটেন্সি কমান।

2. **সিকিউরিটি**:
   - অথেনটিকেশন টোকেন ভ্যালিডেশন সঠিকভাবে করুন।
   - উদাহরণ:

```jsx
import { NextResponse } from "next/server";
import { verifyToken } from "./utils/auth";

export function middleware(request) {
  const token = request.cookies.get("token")?.value;
  if (!verifyToken(token)) {
    return NextResponse.redirect(new URL("/login", request.url));
  }
  return NextResponse.next();
}
```

3. **ক্যাশিং**:
   - মিডলওয়্যারে ক্যাশিং প্রয়োগ করে রিকোয়েস্ট প্রসেসিং দ্রুত করুন।
   - উদাহরণ: ইউজার ডেটা ক্যাশ করা।

4. **এরর হ্যান্ডলিং**:
   - মিডলওয়্যারে ত্রুটি ধরার জন্য try-catch ব্যবহার করুন।
   - উদাহরণ:

```jsx
export function middleware(request) {
  try {
    const token = request.cookies.get("token")?.value;
    if (!token) throw new Error("No token found");
    return NextResponse.next();
  } catch (error) {
    console.error("Middleware Error:", error.message);
    return NextResponse.redirect(new URL("/error", request.url));
  }
}
```

5. **ম্যাচার স্পেসিফিকেশন**:
   - `config.matcher` সঠিকভাবে সেট করুন যাতে মিডলওয়্যার শুধুমাত্র প্রয়োজনীয় রাউটে প্রয়োগ হয়।
   - উদাহরণ: `/dashboard/:path*` শুধুমাত্র ড্যাশবোর্ড রাউটে।

6. **লগিং এবং মনিটরিং**:
   - মিডলওয়্যারে রিকোয়েস্ট লগ করুন এবং ত্রুটি ট্র্যাক করতে Sentry বা Datadog ব্যবহার করুন।
   - উদাহরণ:

```jsx
export function middleware(request) {
  console.log(`Request to ${request.nextUrl.pathname} from ${request.ip}`);
  return NextResponse.next();
}
```

7. **ইন্টারন্যাশনালাইজেশন (i18n)**:
   - ইউজারের ভাষা বা লোকেলের উপর ভিত্তি করে রিডাইরেক্ট করুন।
   - উদাহরণ:

```jsx
export function middleware(request) {
  const locale = request.headers.get("accept-language")?.split(",")[0] || "en";
  if (locale !== "en" && request.nextUrl.pathname === "/") {
    return NextResponse.redirect(new URL(`/${locale}`, request.url));
  }
  return NextResponse.next();
}
```

---

## সুবিধা এবং চ্যালেঞ্জ

### সুবিধা:
- **নমনীয়তা**: রিকোয়েস্ট প্রসেসিংয়ে কাস্টম লজিক যোগ করা যায়।
- **সিকিউরিটি**: অথেনটিকেশন এবং অথরাইজেশন চেক করা।
- **পারফরম্যান্স**: এজ রানটাইমে দ্রুত প্রসেসিং।
- **ইউজার এক্সপেরিয়েন্স**: রিডাইরেকশন বা কাস্টম হেডার দিয়ে ইউজার এক্সপেরিয়েন্স উন্নত করা।

### চ্যালেঞ্জ:
- **পারফরম্যান্স ওভারহেড**: ভারী লজিক মিডলওয়্যারে যোগ করলে লেটেন্সি বাড়তে পারে।
- **জটিলতা**: একাধিক মিডলওয়্যার চেইনিং জটিল হতে পারে।
- **এজ রানটাইম লিমিটেশন**: এজ রানটাইমে কিছু Node.js API (যেমন `fs`) ব্যবহার করা যায় না।

---

## বাস্তব-বিশ্বে ব্যবহারের উদাহরণ

1. **অথেনটিকেশন**:
   - `/dashboard` রাউটে অ্যাক্সেসের আগে ইউজার লগইন চেক।
   - উদাহরণ: JWT টোকেন যাচাই।

2. **ইন্টারন্যাশনালাইজেশন**:
   - ই�\Microsoft Word - Next.js_Concepts_for_Senior_Developers.mdউজারের ভাষা অনুযায়ী পেজ রিডাইরেক্ট।
   - উদাহরণ: `/en` বা `/bn` রাউটে রিডাইরেক্ট।

3. **A/B টেস্টিং**:
   - ইউজার গ্রুপের উপর ভিত্তি করে ভিন্ন UI দেখানো।
   - উদাহরণ: ৫০% ইউজারের জন্য নতুন ডিজাইন।

4. **লগিং**:
   - প্রতিটি রিকোয়েস্টের IP, URL, এবং টাইম লগ করা।
   - উদাহরণ: মনিটরিং টুলে ডেটা পাঠানো।

---

## উপসংহার

Next.js-এ মিডলওয়্যার একটি অত্যন্ত শক্তিশালী টুল, যা রিকোয়েস্ট প্রসেসিংয়ে নমনীয়তা এবং নিয়ন্ত্রণ প্রদান করে। এটি অথেনটিকেশন, রিডাইরেকশন, লগিং, এবং কাস্টম হেডার পরিচালনার জন্য আদর্শ। সিনিয়র ডেভেলপার হিসেবে মিডলওয়্যারের সঠিক ব্যবহার পারফরম্যান্স, সিকিউরিটি, এবং ইউজার এক্সপেরিয়েন্স উন্নত করতে সহায়ক। পারফরম্যান্স অপটিমাইজেশন, সিকিউরিটি, এবং এরর হ্যান্ডলিংয়ের দিকে বিশেষ মনোযোগ দিয়ে মিডলওয়্যার ডিজাইন করুন এবং App Router-এর এজ রানটাইম ব্যবহার করে দ্রুত এবং স্কেলেবল অ্যাপ তৈরি করুন।